<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alert & Escalation - Real-time Crisis Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .alert-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .alert-card {
      padding: 20px;
      border-radius: 12px;
      border-left: 5px solid;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .alert-card.critical {
      background: rgba(255, 77, 77, 0.1);
      border-left-color: #ff4d4d;
    }

    .alert-card.high {
      background: rgba(255, 215, 0, 0.1);
      border-left-color: #ffd700;
    }

    .alert-title {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .alert-card.critical .alert-title {
      color: #ff4d4d;
    }

    .alert-card.high .alert-title {
      color: #ffd700;
    }

    .alert-meta {
      color: var(--muted);
      font-size: 0.85rem;
      margin-bottom: 15px;
    }

    .alert-detail {
      margin: 10px 0;
      font-size: 0.9rem;
    }

    .alert-detail-label {
      color: var(--muted);
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .alert-detail-value {
      color: var(--cyan);
      font-weight: 600;
      margin-top: 3px;
    }

    .truck-assignment {
      background: rgba(54, 240, 255, 0.15);
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid rgba(54, 240, 255, 0.3);
    }

    .truck-name {
      color: var(--cyan);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .truck-status {
      color: var(--emerald);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .escalation-rules {
      display: grid;
      gap: 15px;
      margin: 20px 0;
    }

    .rule {
      padding: 15px;
      background: rgba(54, 240, 255, 0.05);
      border-left: 3px solid var(--cyan);
      border-radius: 8px;
    }

    .rule-condition {
      color: var(--cyan);
      font-weight: 600;
      margin-bottom: 8px;
    }

    .rule-action {
      color: var(--emerald);
      font-size: 0.9rem;
    }

    .rule-priority {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(255, 215, 0, 0.2);
      color: #ffd700;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .truck-deployment {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .truck-card {
      padding: 15px;
      background: rgba(54, 240, 255, 0.05);
      border: 1px solid rgba(54, 240, 255, 0.2);
      border-radius: 8px;
      text-align: center;
    }

    .truck-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--cyan);
    }

    .truck-info {
      color: var(--muted);
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .truck-status-badge {
      display: inline-block;
      padding: 6px 12px;
      background: rgba(30, 142, 62, 0.2);
      color: var(--emerald);
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 8px;
    }

    .truck-status-badge.inactive {
      background: rgba(201, 201, 201, 0.2);
      color: var(--muted);
    }

    .alert-timeline {
      position: relative;
      padding: 20px 0;
    }

    .alert-timeline-item {
      display: flex;
      margin-bottom: 25px;
      padding-left: 40px;
      position: relative;
    }

    .alert-timeline-item::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      width: 12px;
      height: 12px;
      background: var(--cyan);
      border-radius: 50%;
      border: 3px solid var(--navy);
    }

    .alert-timeline-item::after {
      content: '';
      position: absolute;
      left: 14px;
      top: 12px;
      width: 1px;
      height: 25px;
      background: rgba(54, 240, 255, 0.2);
    }

    .alert-timeline-item:last-child::after {
      display: none;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-time {
      color: var(--cyan);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .timeline-event {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="bg">
    <div class="grid"></div>
    <canvas id="particles"></canvas>
  </div>

  <header class="topbar">
    <div class="brand">
      <div style="cursor: pointer;" onclick="window.location.href='intelligence-dashboard.html'">
        <div class="logo">MS</div>
      </div>
      <div>
        <div class="brand-title">ALERT & ESCALATION</div>
        <div class="brand-sub">Real-Time Crisis Management</div>
      </div>
    </div>
    <div class="actions">
      <button class="ghost" onclick="window.location.href='intelligence-dashboard.html'">‚Üê Back to Dashboard</button>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="hero-content">
        <div class="chip">Module 3 / 6</div>
        <h1>Alert & Escalation</h1>
        <p>Automated alert generation with intelligent truck assignment, escalation rules, and real-time crisis management for waste emergencies.</p>
        <div class="hero-stats">
          <div class="stat glass">
            <div class="stat-value" id="totalAlerts">0</div>
            <div class="stat-label">Active Alerts</div>
          </div>
          <div class="stat glass">
            <div class="stat-value" id="criticalAlerts">0</div>
            <div class="stat-label">Critical</div>
          </div>
          <div class="stat glass">
            <div class="stat-value" id="trucksDeployed">0</div>
            <div class="stat-label">Trucks Deployed</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Active Alerts</h2>
        <p>Real-time crisis situations requiring immediate response</p>
      </div>
      <div class="alert-grid" id="alertsGrid">
        <div style="grid-column: 1 / -1; color: var(--muted); padding: 40px; text-align: center;">
          Generating alerts from predictions...
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Truck Deployment Status</h2>
      </div>
      <div class="truck-deployment" id="truckStatus">
        <div class="truck-card">
          <div class="truck-number">üöõ</div>
          <div class="truck-info">Loading vehicles...</div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Escalation Rules Engine</h2>
        <p>Automated triggers that generate alerts and assign resources</p>
      </div>
      <div class="card glass">
        <div class="escalation-rules">
          <div class="rule">
            <div class="rule-condition">üíß Overflow Risk > 50%</div>
            <div class="rule-action">Generate HIGH alert + Assign closest truck</div>
            <span class="rule-priority">P1</span>
          </div>
          <div class="rule">
            <div class="rule-condition">üö® Overflow Risk > 75%</div>
            <div class="rule-action">Generate CRITICAL alert + Assign 2 trucks + Escalate to supervisor</div>
            <span class="rule-priority">P0</span>
          </div>
          <div class="rule">
            <div class="rule-condition">üö´ Illegal Dumping Detected</div>
            <div class="rule-action">Generate HIGH alert + Notify enforcement + Assign truck</div>
            <span class="rule-priority">P1</span>
          </div>
          <div class="rule">
            <div class="rule-condition">üìä Cleanliness Index < 40</div>
            <div class="rule-action">Generate MEDIUM alert + Schedule extra collection</div>
            <span class="rule-priority">P2</span>
          </div>
          <div class="rule">
            <div class="rule-condition">üîÑ Response Time > 4 hours</div>
            <div class="rule-action">Generate alert + Reassign truck + Escalate</div>
            <span class="rule-priority">P1</span>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Alert Timeline (Last 24 Hours)</h2>
      </div>
      <div class="card glass">
        <div class="alert-timeline" id="timeline">
          <div style="color: var(--muted); text-align: center; padding: 20px;">
            Building alert history...
          </div>
        </div>
      </div>
    </section>


  </main>

  <script src="intelligence.js"></script>
  <script>
    function initializeMockData() {
      intelligenceEngine.wards = [
        { id: 1, name: 'SS Colony Ward 1', population: 12500, wasteAmount: 75, cleanlinessIndex: 72 },
        { id: 2, name: 'Anna Main Road', population: 15800, wasteAmount: 85, cleanlinessIndex: 68 },
        { id: 3, name: 'Meenakshi Temple Zone', population: 18200, wasteAmount: 92, cleanlinessIndex: 45 },
        { id: 4, name: 'KK Nagar Ward 7', population: 14100, wasteAmount: 71, cleanlinessIndex: 78 },
        { id: 5, name: 'Vilakkuthoon Ward', population: 11300, wasteAmount: 62, cleanlinessIndex: 82 }
      ];

      intelligenceEngine.reports = [
        { id: 1, wardId: 1, illegalDumping: false, severity: 0.6, createdAt: new Date(Date.now() - 3600000) },
        { id: 2, wardId: 2, illegalDumping: true, severity: 0.8, createdAt: new Date(Date.now() - 7200000) },
        { id: 3, wardId: 1, illegalDumping: false, severity: 0.5, createdAt: new Date(Date.now() - 10800000) },
        { id: 4, wardId: 3, illegalDumping: true, severity: 0.9, createdAt: new Date(Date.now() - 14400000) },
        { id: 5, wardId: 2, illegalDumping: false, severity: 0.6, createdAt: new Date(Date.now() - 21600000) }
      ];

      intelligenceEngine.trucks = [
        { id: 1, name: 'TN-58-MR-4012', status: 'active', assignedWard: 2 },
        { id: 2, name: 'TN-58-MR-4023', status: 'active', assignedWard: 3 },
        { id: 3, name: 'TN-58-MR-4087', status: 'available', assignedWard: null },
        { id: 4, name: 'TN-58-MR-4091', status: 'available', assignedWard: null }
      ];
    }

    // Fetch alerts and trucks from API
    async function fetchAlertsAndTrucks() {
      try {
        const [alertsResp, trucksResp] = await Promise.all([
          fetch('http://localhost:3000/api/intelligence/alerts'),
          fetch('http://localhost:3000/api/trucks')
        ]);
        if (!alertsResp.ok || !trucksResp.ok) throw new Error('API error');
        const alertsData = await alertsResp.json();
        const trucksData = await trucksResp.json();
        return { alerts: alertsData.data, trucks: trucksData.data };
      } catch (error) {
        console.warn('API error, using fallback:', error);
        initializeMockData();
        return {
          alerts: intelligenceEngine.generateAlerts(),
          trucks: intelligenceEngine.trucks
        };
      }
    }

    async function updateModule() {
      const { alerts, trucks } = await fetchAlertsAndTrucks();

      // Alerts grid
      const alertsGrid = document.getElementById('alertsGrid');
      if (alerts.length > 0) {
        alertsGrid.innerHTML = alerts.slice(0, 6).map(alert => `
          <div class="card glass alert-card ${alert.severity.toLowerCase()}">
            <div class="alert-title">üö® ${alert.wardName}</div>
            <div class="alert-meta">${alert.type.replace(/_/g, ' ')} | ${new Date(alert.createdAt).toLocaleTimeString()}</div>
            <div class="alert-detail">
              <div class="alert-detail-label">Alert Type</div>
              <div class="alert-detail-value">${alert.type}</div>
            </div>
            <div class="alert-detail">
              <div class="alert-detail-label">Severity</div>
              <div class="alert-detail-value">${alert.severity}</div>
            </div>
            <div class="alert-detail">
              <div class="alert-detail-label">Message</div>
              <div class="alert-detail-value" style="font-size: 0.85rem;">${alert.message}</div>
            </div>
          </div>
        `).join('');
      } else {
        alertsGrid.innerHTML = '<div style="grid-column: 1 / -1; color: var(--muted); padding: 40px; text-align: center;">No active alerts - System operating normally</div>';
      }

      // Truck deployment
      const truckStatus = document.getElementById('truckStatus');
      truckStatus.innerHTML = trucks.map((truck, idx) => `
        <div class="truck-card">
          <div class="truck-number">${idx + 1}</div>
          <div class="truck-info">${truck.name}</div>
          <div class="truck-status-badge${truck.status === 'available' ? ' inactive' : ''}">${truck.status.toUpperCase()}${truck.assignedWard ? ` - W${truck.assignedWard}` : ''}</div>
        </div>
      `).join('');

      // Timeline
      const timeline = document.getElementById('timeline');
      const timelineEvents = [
        { time: '14:32', event: 'ALERT: Ward 2 - Overflow risk 78%', type: 'CRITICAL' },
        { time: '14:33', event: 'ASSIGNED: Truck TN-58-MR-4023 dispatched to Ward 2', type: 'ACTION' },
        { time: '14:45', event: 'UPDATE: Truck TN-58-MR-4023 arrived at Ward 2', type: 'UPDATE' },
        { time: '15:12', event: 'RESOLVED: Waste collection completed at Ward 2', type: 'RESOLVED' },
        { time: '15:15', event: 'ALERT: Ward 3 - Illegal dumping detected', type: 'HIGH' },
        { time: '15:16', event: 'ASSIGNED: Truck TN-58-MR-4087 dispatched to Ward 3', type: 'ACTION' }
      ];

      timeline.innerHTML = timelineEvents.map(evt => `
        <div class="alert-timeline-item">
          <div class="timeline-content">
            <div class="timeline-time">${evt.time}</div>
            <div class="timeline-event">${evt.event}</div>
          </div>
        </div>
      `).join('');

      // Stats
      document.getElementById('totalAlerts').textContent = alerts.length;
      document.getElementById('criticalAlerts').textContent = alerts.filter(a => a.severity === 'CRITICAL').length;
      document.getElementById('trucksDeployed').textContent = trucks.filter(t => t.status === 'active').length;
    }

    document.addEventListener('DOMContentLoaded', updateModule);
  </script>
  <script src="enhanced-app.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Optimization ‚Äì Madurai Swachh AI Grid</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/pages/shared/theme.css">

    <style>
        .route-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
            height: calc(100vh - 140px);
        }

        .config-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .map-wrapper {
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.4);
            position: relative;
            height: 100%;
        }

        .truck-select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text);
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
        }

        .truck-select:focus {
            border-color: var(--cyan);
        }

        .hotspot-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .hotspot-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hotspot-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .hotspot-item.selected {
            border-color: var(--cyan);
            background: rgba(54, 240, 255, 0.05);
        }

        .hotspot-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid var(--muted);
            display: grid;
            place-items: center;
        }

        .hotspot-item.selected .hotspot-checkbox {
            background: var(--cyan);
            border-color: var(--cyan);
        }

        .hotspot-item.selected .hotspot-checkbox::after {
            content: '‚úì';
            color: #000;
            font-size: 12px;
            font-weight: bold;
        }

        .hotspot-details h4 {
            margin: 0 0 4px 0;
            font-size: 0.9rem;
        }

        .hotspot-details p {
            margin: 0;
            font-size: 0.75rem;
            color: var(--muted);
        }

        .savings-panel {
            display: none;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(54, 240, 255, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            animation: fadeIn 0.4s ease forwards;
        }

        .savings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .saving-metric {
            text-align: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .saving-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
        }

        .saving-label {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 4px;
        }

        .route-step {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            position: relative;
        }

        .route-step::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 24px;
            bottom: -16px;
            width: 2px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        .route-step:last-child::before {
            display: none;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--cyan);
            color: #000;
            display: grid;
            place-items: center;
            font-size: 0.8rem;
            font-weight: 700;
            z-index: 2;
            flex-shrink: 0;
        }

        @media (max-width: 900px) {
            .route-grid {
                grid-template-columns: 1fr;
                height: auto;
            }

            .map-wrapper {
                height: 400px;
            }
        }
    </style>
</head>

<body>

    <div class="route-grid animate-fade-in">
        <!-- Configuration Panel -->
        <div class="glass-panel config-panel">
            <h2 style="font-size: 1.2rem; margin: 0 0 16px;">üìç Live Ward Map</h2>
            <p style="font-size: 0.85rem; color: var(--muted); margin: 0 0 20px;">Interactive map showing Madurai wards with real-time data</p>

            <div>
                <label style="font-size: 0.8rem; color: var(--muted); margin-bottom: 8px; display: block;">Ward Statistics</label>
                <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--muted); font-size: 0.8rem;">Total Wards:</span>
                        <span id="totalWards" style="font-weight: 600;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--muted); font-size: 0.8rem;">Active Reports:</span>
                        <span id="totalReports" style="font-weight: 600; color: var(--warning);">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--muted); font-size: 0.8rem;">Critical Zones:</span>
                        <span id="criticalWards" style="font-weight: 600; color: var(--danger);">-</span>
                    </div>
                </div>
            </div>

            <div>
                <label style="font-size: 0.8rem; color: var(--muted); margin-bottom: 8px; display: block;">Filter by Zone</label>
                <select class="truck-select" id="zoneFilter" onchange="filterWards()">
                    <option value="">All Zones</option>
                    <option value="North">North Zone</option>
                    <option value="South">South Zone</option>
                    <option value="East">East Zone</option>
                    <option value="West">West Zone</option>
                    <option value="Central">Central Zone</option>
                </select>
            </div>

            <div style="margin-top: 16px;">
                <label style="font-size: 0.8rem; color: var(--muted); margin-bottom: 8px; display: block;">Recent Hotspots</label>
                <div class="hotspot-list" id="hotspotList">
                    <div style="text-align: center; padding: 20px; color: var(--muted); font-size: 0.85rem;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">üìç</div>
                        Loading wards...
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 24px; padding: 14px;" onclick="refreshMap()">
                üîÑ Refresh Ward Data
            </button>

            <!-- Ward Details Panel -->
            <div class="savings-panel" id="wardDetailsPanel" style="display: none;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2rem;">üìç</span>
                    <h3 style="margin: 0; font-size: 1rem; color: var(--cyan);" id="selectedWardName">Ward Details</h3>
                </div>

                <div class="savings-grid" id="wardStats">
                    <!-- Ward details will be populated here -->
                </div>

                <div style="margin-top: 16px;" id="wardInfo">
                    <!-- Additional ward information -->
                </div>
            </div>
        </div>

        <!-- Map Area -->
        <div class="map-wrapper" id="routeMap"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/pages/shared/navigation.js"></script>
    <script>
        let routeMap;
        let markersGroup;
        let allWards = [];
        let allReports = [];
        const API_BASE = 'http://localhost:5000/api';

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                routeMap = L.map('routeMap', {
                    zoomControl: true,
                    attributionControl: true
                }).setView([9.9252, 78.1198], 13);

                // OpenStreetMap tiles like in the image
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(routeMap);

                markersGroup = L.layerGroup().addTo(routeMap);

                // Load ward data
                loadWardData();
            }, 300);
        });

        async function loadWardData() {
            try {
                // Fetch wards and reports
                const [wardsRes, reportsRes] = await Promise.all([
                    fetch(`${API_BASE}/wards`),
                    fetch(`${API_BASE}/reports`)
                ]);

                const wardsData = await wardsRes.json();
                const reportsData = await reportsRes.json();

                allWards = wardsData.data || [];
                allReports = reportsData.data || [];

                // Update statistics
                updateStatistics();

                // Add ward markers to map
                addWardMarkers();

                // Update hotspot list
                updateHotspotList();

            } catch (error) {
                console.error('Error loading ward data:', error);
                // Show fallback data if API fails
                loadFallbackData();
            }
        }

        function loadFallbackData() {
            // Fallback ward locations for Madurai
            allWards = [
                { wardNumber: 1, name: 'SS Colony', zone: 'Central', location: { latitude: 9.9252, longitude: 78.1198 } },
                { wardNumber: 2, name: 'Anna Nagar', zone: 'East', location: { latitude: 9.9350, longitude: 78.1350 } },
                { wardNumber: 3, name: 'Arapalayam', zone: 'North', location: { latitude: 9.9450, longitude: 78.1150 } },
                { wardNumber: 4, name: 'Simmakkal', zone: 'Central', location: { latitude: 9.9180, longitude: 78.1280 } },
                { wardNumber: 5, name: 'Ellis Nagar', zone: 'South', location: { latitude: 9.9100, longitude: 78.1200 } },
                { wardNumber: 6, name: 'KK Nagar', zone: 'West', location: { latitude: 9.9300, longitude: 78.1050 } },
                { wardNumber: 7, name: 'Pasumalai', zone: 'West', location: { latitude: 9.9050, longitude: 78.0950 } },
                { wardNumber: 8, name: 'Meenakshi Nagar', zone: 'East', location: { latitude: 9.9400, longitude: 78.1450 } },
                { wardNumber: 9, name: 'Thirunagar', zone: 'North', location: { latitude: 9.9550, longitude: 78.1250 } },
                { wardNumber: 10, name: 'Vilangudi', zone: 'South', location: { latitude: 9.9000, longitude: 78.1400 } },
                { wardNumber: 11, name: 'TVS Nagar', zone: 'Central', location: { latitude: 9.9280, longitude: 78.1320 } },
                { wardNumber: 12, name: 'Colony', zone: 'East', location: { latitude: 9.9320, longitude: 78.1500 } },
                { wardNumber: 13, name: 'Goripalayam', zone: 'Central', location: { latitude: 9.9220, longitude: 78.1150 } },
                { wardNumber: 14, name: 'Bibikulam', zone: 'West', location: { latitude: 9.9150, longitude: 78.1000 } },
                { wardNumber: 15, name: 'Anna Bus Stand', zone: 'Central', location: { latitude: 9.9280, longitude: 78.1235 } }
            ];
            allReports = [];
            updateStatistics();
            addWardMarkers();
            updateHotspotList();
        }

        function updateStatistics() {
            document.getElementById('totalWards').textContent = allWards.length;
            document.getElementById('totalReports').textContent = allReports.length;
            
            // Count critical wards (those with high severity reports)
            const criticalCount = allWards.filter(w => {
                const wardReports = allReports.filter(r => r.wardNumber === w.wardNumber);
                return wardReports.some(r => r.severityScore >= 4);
            }).length;
            document.getElementById('criticalWards').textContent = criticalCount;
        }

        function addWardMarkers() {
            markersGroup.clearLayers();

            const zoneFilter = document.getElementById('zoneFilter')?.value;

            allWards.forEach(ward => {
                // Apply zone filter
                if (zoneFilter && ward.zone !== zoneFilter) return;

                const lat = ward.location?.latitude || ward.centerPoint?.[0] || 9.9252;
                const lng = ward.location?.longitude || ward.centerPoint?.[1] || 78.1198;

                // Count reports for this ward
                const wardReports = allReports.filter(r => r.wardNumber === ward.wardNumber);
                const criticalReports = wardReports.filter(r => r.severityScore >= 4).length;

                // Color based on reports
                const color = criticalReports > 0 ? '#ef4444' : wardReports.length > 2 ? '#f59e0b' : '#3b82f6';

                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                }).addTo(markersGroup);

                // Click handler
                marker.on('click', () => {
                    showWardDetails(ward, wardReports);
                });

                // Tooltip
                marker.bindTooltip(`Ward ${ward.wardNumber}: ${ward.name || 'Unknown'}`, {
                    direction: 'top',
                    offset: [0, -10]
                });
            });
        }

        function updateHotspotList() {
            const hotspotList = document.getElementById('hotspotList');
            if (!hotspotList) return;

            // Get wards with reports, sorted by severity
            const wardsWithReports = allWards.map(ward => {
                const wardReports = allReports.filter(r => r.wardNumber === ward.wardNumber);
                const avgSeverity = wardReports.length > 0 
                    ? wardReports.reduce((sum, r) => sum + (r.severityScore || 3), 0) / wardReports.length 
                    : 0;
                return { ward, reportsCount: wardReports.length, avgSeverity };
            }).filter(w => w.reportsCount > 0).sort((a, b) => b.avgSeverity - a.avgSeverity).slice(0, 5);

            if (wardsWithReports.length === 0) {
                hotspotList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--muted); font-size: 0.85rem;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">‚úÖ</div>
                        No active hotspots
                    </div>
                `;
                return;
            }

            hotspotList.innerHTML = wardsWithReports.map(({ ward, reportsCount, avgSeverity }) => {
                const badgeClass = avgSeverity >= 4 ? 'badge-high' : avgSeverity >= 3 ? 'badge-medium' : 'badge-low';
                const badgeText = avgSeverity >= 4 ? 'CRITICAL' : avgSeverity >= 3 ? 'HIGH' : 'MODERATE';
                
                return `
                    <div class="hotspot-item" onclick="focusOnWard(${ward.wardNumber})" style="cursor: pointer;">
                        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${avgSeverity >= 4 ? '#ef4444' : '#f59e0b'};"></div>
                        <div class="hotspot-details" style="flex: 1;">
                            <h4>Ward ${ward.wardNumber}: ${ward.name || 'Unknown'} 
                                <span class="badge ${badgeClass}" style="font-size: 0.55rem; margin-left: 4px;">${badgeText}</span>
                            </h4>
                            <p>${reportsCount} active report${reportsCount !== 1 ? 's' : ''} ‚Ä¢ Avg severity: ${avgSeverity.toFixed(1)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function focusOnWard(wardNumber) {
            const ward = allWards.find(w => w.wardNumber === wardNumber);
            if (!ward) return;

            const lat = ward.location?.latitude || ward.centerPoint?.[0] || 9.9252;
            const lng = ward.location?.longitude || ward.centerPoint?.[1] || 78.1198;

            routeMap.setView([lat, lng], 15, { animate: true });
            
            const wardReports = allReports.filter(r => r.wardNumber === ward.wardNumber);
            showWardDetails(ward, wardReports);
        }

        function showWardDetails(ward, reports) {
            const panel = document.getElementById('wardDetailsPanel');
            const nameEl = document.getElementById('selectedWardName');
            const statsEl = document.getElementById('wardStats');
            const infoEl = document.getElementById('wardInfo');

            panel.style.display = 'block';
            nameEl.textContent = `Ward ${ward.wardNumber}: ${ward.name || 'Unknown'}`;

            // Calculate statistics
            const criticalReports = reports.filter(r => r.severityScore >= 4).length;
            const avgSeverity = reports.length > 0 
                ? reports.reduce((sum, r) => sum + (r.severityScore || 3), 0) / reports.length 
                : 0;

            statsEl.innerHTML = `
                <div class="saving-metric">
                    <div class="saving-value">${reports.length}</div>
                    <div class="saving-label">Total Reports</div>
                </div>
                <div class="saving-metric">
                    <div class="saving-value" style="color: var(--danger);">${criticalReports}</div>
                    <div class="saving-label">Critical</div>
                </div>
                <div class="saving-metric">
                    <div class="saving-value" style="color: var(--warning);">${avgSeverity.toFixed(1)}</div>
                    <div class="saving-label">Avg Severity</div>
                </div>
                <div class="saving-metric">
                    <div class="saving-value" style="color: var(--cyan);">${ward.zone || 'N/A'}</div>
                    <div class="saving-label">Zone</div>
                </div>
            `;

            infoEl.innerHTML = `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; font-size: 0.85rem;">
                    <div style="color: var(--muted); margin-bottom: 4px;">Area: ${ward.area || 'N/A'} km¬≤</div>
                    <div style="color: var(--muted); margin-bottom: 4px;">Population: ${ward.population?.toLocaleString() || 'N/A'}</div>
                    <div style="color: var(--muted);">Officer: ${ward.staff?.wardOfficer?.name || 'Unassigned'}</div>
                </div>
            `;

            // Scroll panel into view
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function filterWards() {
            addWardMarkers();
        }

        function refreshMap() {
            loadWardData();
        }


    </script>
</body>

</html>
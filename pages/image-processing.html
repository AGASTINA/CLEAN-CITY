<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Detection ‚Äì MadurAI Urban Intelligence Grid (MUIG)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/pages/shared/theme.css">

    <style>
        .detection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .upload-area {
            border: 2px dashed rgba(54, 240, 255, 0.3);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(10, 14, 26, 0.5);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #uploadPlaceholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--cyan);
            background: rgba(54, 240, 255, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--cyan);
            margin-bottom: 16px;
        }

        .upload-text {
            color: var(--muted);
            margin-bottom: 20px;
        }

        .upload-options {
            display: flex;
            gap: 12px;
            z-index: 10;
        }

        #imagePreview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            z-index: 5;
            display: none;
        }

        .scanning-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 8;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .scan-line {
            width: 100%;
            height: 4px;
            background: var(--cyan);
            box-shadow: 0 0 15px var(--cyan);
            position: absolute;
            top: 0;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% {
                top: 0;
            }

            50% {
                top: 100%;
            }

            100% {
                top: 0;
            }
        }

        .results-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            opacity: 0.5;
            /* Disabled state initially */
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .results-panel.active {
            opacity: 1;
            pointer-events: auto;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid transparent;
        }

        .result-item.highlight {
            border-left-color: var(--cyan);
            background: rgba(54, 240, 255, 0.05);
        }

        .result-label {
            color: var(--muted);
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .result-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .confidence-bar-bg {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .confidence-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--emerald));
            width: 0%;
            transition: width 1s ease-out;
        }

        .recent-scans {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 24px;
        }

        .scan-thumb {
            aspect-ratio: 1;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scan-thumb:hover {
            border-color: var(--cyan);
        }

        .scan-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        #fileInput {
            display: none;
        }

        @media (max-width: 900px) {
            .detection-grid {
                grid-template-columns: 1fr;
            }

            .recent-scans {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>

    <div class="glass-panel mb-4 animate-fade-in">
        <div class="panel-title">
            <span style="font-size: 1.5rem; margin-right: 8px;">ü§ñ</span> AI Waste Classification System
        </div>
        <p class="text-muted" style="margin-top: 0;">Upload waste images or use live camera feed to automatically classify waste type, assess threat level, and receive segregation recommendations powered by Gemini AI.</p>

        <div class="detection-grid mt-4">
            <!-- Left: Upload Area -->
            <div class="upload-container">
                <div class="upload-area" id="dropZone">
                    <img id="imagePreview" src="" alt="Preview">

                    <div class="scanning-overlay" id="scanningOverlay">
                        <div class="scan-line"></div>
                        <div style="font-size: 2rem; margin-bottom: 10px;">üß†</div>
                        <div style="font-weight: 600; color: var(--cyan);">Running Vision Models...</div>
                        <div style="font-size: 0.8rem; color: var(--muted); margin-top: 4px;">Classifying waste streams
                        </div>
                    </div>

                    <div id="uploadPlaceholder">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-text">Drag & drop image here or click to browse</div>
                        <div class="upload-options">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('fileInput').click();">Browse Files</button>
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); openCamera(event);">Open Camera</button>
                        </div>
                    </div>

                    <!-- Camera View -->
                    <div id="cameraView" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 6; background: #000; flex-direction: column; align-items: center; justify-content: center;">
                        <video id="cameraFeed" autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;"></video>
                        <div style="position: absolute; bottom: 20px; display: flex; gap: 12px; z-index: 7;">
                            <button class="btn btn-success" onclick="captureImage()">üì∑ Capture</button>
                            <button class="btn btn-secondary" onclick="closeCamera()">‚ùå Cancel</button>
                        </div>
                    </div>

                    <button id="resetBtn" class="btn btn-secondary"
                        style="position: absolute; top: 10px; right: 10px; z-index: 10; display: none;"
                        onclick="resetCapture(event)">Reset</button>
                </div>
                <input type="file" id="fileInput" accept="image/*,image/jpg,image/jpeg,image/png,image/webp">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                    <div style="font-size: 0.8rem; color: var(--muted);">Supported formats: JPG, PNG, WebP</div>
                    <button class="btn btn-success" id="analyzeBtn" style="display: none;" onclick="runAnalysis()">Run
                        AI Analysis</button>
                </div>
            </div>

            <!-- Right: Results Panel -->
            <div class="results-panel" id="resultsPanel">
                <h3 style="margin: 0 0 8px; color: var(--cyan);">Analysis Results</h3>

                <div class="result-item highlight">
                    <div>
                        <div class="result-label">Primary Waste Type</div>
                        <div class="result-value text-cyan" id="resType">Awaiting Image</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="result-label">Confidence</div>
                        <div class="result-value" id="resConf">--%</div>
                    </div>
                </div>

                <div class="confidence-bar-bg">
                    <div class="confidence-bar-fill" id="confBar"></div>
                </div>

                <div class="result-item" style="margin-top: 8px;">
                    <div class="result-label">Threat Level</div>
                    <div class="result-value" id="resSeverity">--</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Estimated Volume</div>
                    <div class="result-value" id="resVol">--</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Risk Assessment</div>
                    <div class="result-value" id="resRisk">--</div>
                </div>

                <div class="result-item highlight" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                    <div class="result-label">Segregation & Action Plan</div>
                    <div style="font-size: 0.9rem;" id="resAction">Upload an image to get waste management recommendations.
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: auto;">
                    <button class="btn btn-primary" style="flex: 1;" disabled id="btnLog">Log to Database</button>
                    <button class="btn btn-danger" style="flex: 1;" disabled id="btnAlert">Issue Alert</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Data -->
    <div class="glass-panel animate-fade-in" style="animation-delay: 0.2s;">
        <div class="panel-title flex-between">
            <span>Recent Processed Images</span>
            <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 6px 12px;">View All Logs</button>
        </div>

        <div class="recent-scans">
            <div class="scan-thumb"
                style="background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1532996122724-e3c354a0b15b?auto=format&fit=crop&q=80&w=200');">
                <span class="scan-badge badge-high">PLASTIC</span>
                <div style="position: absolute; bottom: 8px; left: 8px; font-size: 0.7rem; color: white;">92% Match
                </div>
            </div>
            <div class="scan-thumb"
                style="background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1604187351574-c75ca79f5807?auto=format&fit=crop&q=80&w=200');">
                <span class="scan-badge badge-low">ORGANIC</span>
                <div style="position: absolute; bottom: 8px; left: 8px; font-size: 0.7rem; color: white;">88% Match
                </div>
            </div>
            <div class="scan-thumb"
                style="background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1594916328320-be1adfbdbd4b?auto=format&fit=crop&q=80&w=200');">
                <span class="scan-badge badge-medium">MIXED</span>
                <div style="position: absolute; bottom: 8px; left: 8px; font-size: 0.7rem; color: white;">81% Match
                </div>
            </div>
            <div class="scan-thumb"
                style="background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1550989460-0adf9ea622e2?auto=format&fit=crop&q=80&w=200');">
                <span class="scan-badge badge-high">E-WASTE</span>
                <div style="position: absolute; bottom: 8px; left: 8px; font-size: 0.7rem; color: white;">96% Match
                </div>
            </div>
        </div>
    </div>

    <script src="/pages/shared/navigation.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000/api';
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const imagePreview = document.getElementById('imagePreview');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const scanningOverlay = document.getElementById('scanningOverlay');
        const resultsPanel = document.getElementById('resultsPanel');
        const cameraView = document.getElementById('cameraView');
        const cameraFeed = document.getElementById('cameraFeed');
        let stream = null;
        let currentImageFile = null;

        // Click handler for dropZone (but not when clicking buttons)
        dropZone.addEventListener('click', (e) => {
            // Only trigger file input if not clicking on a button or camera view
            if (e.target === dropZone || e.target.closest('#uploadPlaceholder')) {
                if (!e.target.classList.contains('btn') && !e.target.closest('.btn')) {
                    fileInput.click();
                }
            }
        });

        // Drag and drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            console.log('File input changed', e.target.files);
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            console.log('Handling file:', file.name, file.type, file.size);
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file (JPG, PNG, WebP)');
                return;
            }

            currentImageFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                uploadPlaceholder.style.display = 'none';
                analyzeBtn.style.display = 'block';
                resetBtn.style.display = 'block';

                // Reset results
                resultsPanel.classList.remove('active');
                document.getElementById('confBar').style.width = '0%';
            };
            reader.readAsDataURL(file);
        }

        // Camera functions
        async function openCamera(event) {
            event.stopPropagation();
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                cameraFeed.srcObject = stream;
                cameraView.style.display = 'flex';
            } catch (error) {
                alert('Unable to access camera: ' + error.message);
            }
        }

        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraView.style.display = 'none';
        }

        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraFeed.videoWidth;
            canvas.height = cameraFeed.videoHeight;
            canvas.getContext('2d').drawImage(cameraFeed, 0, 0);
            
            canvas.toBlob((blob) => {
                const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                closeCamera();
                handleFile(file);
            }, 'image/jpeg', 0.9);
        }

        function resetCapture(event) {
            if (event) event.stopPropagation();
            
            // Close camera if open
            closeCamera();
            
            fileInput.value = '';
            currentImageFile = null;
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            uploadPlaceholder.style.display = 'flex';
            analyzeBtn.style.display = 'none';
            resetBtn.style.display = 'none';
            resultsPanel.classList.remove('active');

            document.getElementById('resType').textContent = 'Awaiting Image';
            document.getElementById('resConf').textContent = '--%';
            document.getElementById('resSeverity').textContent = '--';
            document.getElementById('resVol').textContent = '--';
            document.getElementById('resRisk').textContent = '--';
            document.getElementById('resAction').textContent = 'Upload an image to get governance recommendations.';
            document.getElementById('confBar').style.width = '0%';

            document.getElementById('btnLog').disabled = true;
            document.getElementById('btnAlert').disabled = true;
        }

        async function runAnalysis() {
            if (!currentImageFile) {
                alert('No image selected. Please upload an image first.');
                return;
            }

            console.log('Starting analysis with file:', currentImageFile.name);
            analyzeBtn.disabled = true;
            scanningOverlay.style.display = 'flex';

            try {
                // Create form data with image
                const formData = new FormData();
                formData.append('images', currentImageFile);
                formData.append('latitude', '9.9252');
                formData.append('longitude', '78.1198');
                formData.append('wardNumber', '1');
                formData.append('reporterType', 'officer');

                console.log('Sending request to API...');
                
                // Send to backend for Gemini AI analysis
                const response = await fetch(`${API_BASE}/reports`, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    throw new Error(`Analysis failed: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Analysis result:', result);
                
                scanningOverlay.style.display = 'none';
                analyzeBtn.style.display = 'none';
                
                showResults(result.data);

            } catch (error) {
                console.error('Analysis error:', error);
                scanningOverlay.style.display = 'none';
                analyzeBtn.disabled = false;
                
                // Show mock results as fallback
                const useMock = confirm('Backend API unavailable. Use offline demo mode with mock results?');
                if (useMock) {
                    analyzeBtn.style.display = 'none';
                    showMockResults();
                }
            }
        }

        function showResults(data) {
            resultsPanel.classList.add('active');

            const wasteType = data.wasteType || data.classification?.wasteType || 'Unknown';
            const confidence = data.aiConfidence || data.classification?.aiConfidence || 0;
            const severityScore = data.severityScore || data.classification?.severityScore || 3;
            const volume = data.estimatedVolume || data.classification?.estimatedVolume || 'medium';
            const riskLevel = data.riskLevel || data.classification?.riskLevel || 'moderate';
            const isIllegalDumping = data.isIllegalDumping || data.classification?.isIllegalDumping || false;
            const recommendations = data.recommendations || data.classification?.recommendations || [];
            const explanation = data.explanation || data.aiExplanation || '';

            // Update UI
            document.getElementById('resType').textContent = wasteType.charAt(0).toUpperCase() + wasteType.slice(1);
            document.getElementById('resConf').textContent = `${(confidence * 100).toFixed(1)}%`;
            document.getElementById('confBar').style.width = `${confidence * 100}%`;

            // Severity with color
            const severityText = severityScore >= 4 ? 'CRITICAL' : severityScore >= 3 ? 'HIGH' : 'MODERATE';
            const severityColor = severityScore >= 4 ? 'danger' : severityScore >= 3 ? 'warning' : 'success';
            document.getElementById('resSeverity').innerHTML = `<span class="text-${severityColor}" style="font-weight:700;">${severityText}</span>`;

            // Volume
            document.getElementById('resVol').textContent = volume.charAt(0).toUpperCase() + volume.slice(1);

            // Risk level
            const riskText = isIllegalDumping ? '‚ö†Ô∏è Illegal Dumping Detected' : riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1);
            const riskColor = isIllegalDumping ? 'danger' : riskLevel === 'high' || riskLevel === 'critical' ? 'warning' : 'success';
            document.getElementById('resRisk').innerHTML = `<span class="text-${riskColor}">${riskText}</span>`;

            // Action recommendations
            let actionHTML = '';
            if (explanation) {
                actionHTML += `<div style="margin-bottom: 12px; font-size: 0.85rem; color: var(--muted);">${explanation}</div>`;
            }
            if (recommendations && recommendations.length > 0) {
                actionHTML += '<div style="font-weight: 600; margin-bottom: 8px;">Recommendations:</div>';
                actionHTML += '<ul style="margin: 0; padding-left: 20px; font-size: 0.85rem;">';
                recommendations.forEach(rec => {
                    actionHTML += `<li style="margin-bottom: 4px;">${rec}</li>`;
                });
                actionHTML += '</ul>';
            } else {
                actionHTML += getDefaultRecommendations(wasteType, severityScore, isIllegalDumping);
            }
            document.getElementById('resAction').innerHTML = actionHTML;

            document.getElementById('btnLog').disabled = false;
            document.getElementById('btnAlert').disabled = false;
        }

        function getDefaultRecommendations(wasteType, severity, isIllegal) {
            let html = '<div style="font-weight: 600; margin-bottom: 8px;">Recommendations:</div><ul style="margin: 0; padding-left: 20px; font-size: 0.85rem;">';
            
            if (isIllegal) {
                html += '<li>Alert enforcement team immediately</li>';
                html += '<li>Document location and perpetrators if possible</li>';
            }
            
            if (severity >= 4) {
                html += '<li>Deploy waste collection truck within 2 hours</li>';
                html += '<li>Assign additional cleanup crew</li>';
            } else if (severity >= 3) {
                html += '<li>Schedule collection within next 24 hours</li>';
            }

            if (wasteType.includes('plastic')) {
                html += '<li>Segregate plastic for recycling stream</li>';
                html += '<li>Investigate source to prevent future dumping</li>';
            } else if (wasteType.includes('organic')) {
                html += '<li>Direct to composting facility</li>';
                html += '<li>Monitor for odor and pest issues</li>';
            } else if (wasteType.includes('medical') || wasteType.includes('hazardous')) {
                html += '<li>‚ö†Ô∏è Use specialized hazmat collection procedures</li>';
                html += '<li>Notify health department</li>';
            } else if (wasteType.includes('construction')) {
                html += '<li>Route to C&D waste processing center</li>';
                html += '<li>Verify construction permit compliance</li>';
            }

            html += '</ul>';
            return html;
        }

        function showMockResults() {
            resultsPanel.classList.add('active');

            document.getElementById('resType').textContent = 'Mixed Segregation (Plastic High)';
            document.getElementById('resConf').textContent = '94.2%';
            document.getElementById('confBar').style.width = '94.2%';

            document.getElementById('resSeverity').innerHTML = '<span class="text-danger" style="font-weight:700;">HIGH</span>';
            document.getElementById('resVol').textContent = 'Approx 400-500 kg';
            document.getElementById('resRisk').innerHTML = '<span class="text-warning">Probable Commercial Dumping</span>';

            document.getElementById('resAction').innerHTML = '1. Route <strong>Truck TR-09</strong> immediately.<br>2. Alert ward enforcement officer to investigate nearby commercial complexes for C&D or bulk plastic waste violations.';

            document.getElementById('btnLog').disabled = false;
            document.getElementById('btnAlert').disabled = false;
        }
    </script>
</body>

</html>
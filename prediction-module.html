<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prediction Engine - Overflow Probability</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .prediction-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .prediction-table th,
    .prediction-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid rgba(54, 240, 255, 0.1);
    }

    .prediction-table th {
      background: rgba(54, 240, 255, 0.05);
      color: var(--cyan);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .prediction-table tr:hover {
      background: rgba(54, 240, 255, 0.03);
    }

    .risk-bar {
      width: 200px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .risk-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--emerald), var(--cyan));
    }

    .risk-critical .risk-fill {
      background: linear-gradient(90deg, #ff4d4d, #ff9999);
    }

    .risk-high .risk-fill {
      background: linear-gradient(90deg, #ffd700, #ffed4e);
    }

    .risk-medium .risk-fill {
      background: linear-gradient(90deg, var(--emerald), var(--cyan));
    }

    .urgency-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .urgency-critical {
      background: rgba(255, 77, 77, 0.2);
      color: #ff4d4d;
    }

    .urgency-high {
      background: rgba(255, 215, 0, 0.2);
      color: #ffd700;
    }

    .urgency-medium {
      background: rgba(54, 240, 255, 0.2);
      color: var(--cyan);
    }

    .urgency-low {
      background: rgba(30, 142, 62, 0.2);
      color: var(--emerald);
    }

    .prediction-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .prediction-card {
      padding: 20px;
      background: rgba(54, 240, 255, 0.05);
      border: 1px solid rgba(54, 240, 255, 0.2);
      border-radius: 12px;
    }

    .prediction-card-title {
      color: var(--cyan);
      font-weight: 600;
      margin-bottom: 15px;
    }

    .prediction-stat {
      margin: 10px 0;
    }

    .prediction-stat-label {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .prediction-stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--emerald);
      margin-top: 4px;
    }

    .timeline {
      margin: 30px 0;
    }

    .timeline-item {
      display: flex;
      margin-bottom: 20px;
      padding-left: 40px;
      position: relative;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      width: 12px;
      height: 12px;
      background: var(--cyan);
      border-radius: 50%;
      border: 3px solid var(--navy);
    }

    .timeline-item::after {
      content: '';
      position: absolute;
      left: 14px;
      top: 12px;
      width: 1px;
      height: 20px;
      background: rgba(54, 240, 255, 0.2);
    }

    .timeline-item:last-child::after {
      display: none;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-title {
      color: var(--cyan);
      font-weight: 600;
    }

    .timeline-meta {
      color: var(--muted);
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .forecast-chart {
      margin: 20px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
    }

    .forecast-bar {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .forecast-label {
      width: 100px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .forecast-graph {
      flex: 1;
      height: 30px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      margin: 0 15px;
      position: relative;
      overflow: hidden;
    }

    .forecast-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--emerald), var(--cyan));
    }

    .forecast-value {
      width: 50px;
      text-align: right;
      color: var(--emerald);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="bg">
    <div class="grid"></div>
    <canvas id="particles"></canvas>
  </div>

  <header class="topbar">
    <div class="brand">
      <div style="cursor: pointer;" onclick="window.location.href='intelligence-dashboard.html'">
        <div class="logo">MS</div>
      </div>
      <div>
        <div class="brand-title">PREDICTION ENGINE</div>
        <div class="brand-sub">Overflow Probability Analysis</div>
      </div>
    </div>
    <div class="actions">
      <button class="ghost" onclick="window.location.href='intelligence-dashboard.html'">‚Üê Back to Dashboard</button>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="hero-content">
        <div class="chip">Module 2 / 6</div>
        <h1>Prediction Engine</h1>
        <p>Real-time overflow probability analysis using waste accumulation patterns, seasonal trends, and historical data to predict bin capacity breaches.</p>
        <div class="hero-stats">
          <div class="stat glass">
            <div class="stat-value" id="avgOverflow">0%</div>
            <div class="stat-label">Avg Overflow Risk</div>
          </div>
          <div class="stat glass">
            <div class="stat-value" id="riskWards">0</div>
            <div class="stat-label">At-Risk Wards</div>
          </div>
          <div class="stat glass">
            <div class="stat-value" id="confidence">95%</div>
            <div class="stat-label">Forecast Confidence</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Ward-by-Ward Risk Assessment</h2>
        <p>Current overflow probability for all wards with urgency levels</p>
      </div>
      <div class="card glass">
        <table class="prediction-table">
          <thead>
            <tr>
              <th>Ward Name</th>
              <th>Current Load</th>
              <th>Capacity</th>
              <th>Overflow Probability</th>
              <th>Hours to Overflow</th>
              <th>Urgency</th>
            </tr>
          </thead>
          <tbody id="wardTable">
            <tr>
              <td colspan="6" style="text-align: center; color: var(--muted);">Loading predictions...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>7-Day Forecast</h2>
      </div>
      <div class="card glass">
        <div class="forecast-chart" id="forecastChart">
          <div style="color: var(--muted); text-align: center; padding: 20px;">
            Generating 7-day waste accumulation forecast...
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Critical Ward Analysis</h2>
      </div>

      <div class="prediction-grid" id="criticalWards">
        <div class="prediction-card">
          <div class="prediction-card-title">üìä Top Risk Ward</div>
          <div class="prediction-stat">
            <div class="prediction-stat-label">Ward Name</div>
            <div class="prediction-stat-value" style="color: #ffd700;">Loading...</div>
          </div>
          <div class="prediction-stat">
            <div class="prediction-stat-label">Overflow Risk</div>
            <div class="prediction-stat-value" style="color: #ffd700;">--%</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Prediction Timeline</h2>
        <p>Chronological forecast events for the next 7 days</p>
      </div>
      <div class="card glass">
        <div class="timeline" id="timeline">
          <div style="color: var(--muted); text-align: center; padding: 20px;">
            Building 7-day timeline...
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Algorithm Details</h2>
      </div>
      <div class="card glass">
        <div style="padding: 20px 0;">
          <div style="margin-bottom: 20px;">
            <div style="color: var(--cyan); font-weight: 600; margin-bottom: 8px;">Formula</div>
            <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
              overflowProbability = (projectedLoad / binCapacity) √ó (1 + avgSeverity) √ó 100
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="color: var(--cyan); font-weight: 600; margin-bottom: 8px;">Inputs</div>
            <ul style="list-style: none; padding: 0;">
              <li style="padding: 8px 0; color: var(--muted);"><strong>projectedLoad:</strong> Expected waste volume in next period</li>
              <li style="padding: 8px 0; color: var(--muted);"><strong>binCapacity:</strong> Maximum bin capacity in kg</li>
              <li style="padding: 8px 0; color: var(--muted);"><strong>avgSeverity:</strong> Average severity score (0-1) from 7-day history</li>
            </ul>
          </div>

          <div>
            <div style="color: var(--cyan); font-weight: 600; margin-bottom: 8px;">Output</div>
            <ul style="list-style: none; padding: 0;">
              <li style="padding: 8px 0; color: var(--muted);"><strong>Probability %:</strong> 0-100% chance of overflow</li>
              <li style="padding: 8px 0; color: var(--muted);"><strong>hoursToOverflow:</strong> Time until breach expected</li>
              <li style="padding: 8px 0; color: var(--muted);"><strong>urgencyLevel:</strong> LOW / MEDIUM / HIGH / CRITICAL</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="intelligence.js"></script>
  <script>
    function initializeMockData() {
      intelligenceEngine.wards = [
        { id: 1, name: 'SS Colony Ward 1', population: 12500, wasteAmount: 75, cleanlinessIndex: 72 },
        { id: 2, name: 'Anna Main Road', population: 15800, wasteAmount: 85, cleanlinessIndex: 68 },
        { id: 3, name: 'Meenakshi Temple Zone', population: 18200, wasteAmount: 92, cleanlinessIndex: 65 },
        { id: 4, name: 'KK Nagar Ward 7', population: 14100, wasteAmount: 71, cleanlinessIndex: 78 },
        { id: 5, name: 'Vilakkuthoon Ward', population: 11300, wasteAmount: 62, cleanlinessIndex: 82 }
      ];

      intelligenceEngine.reports = [
        { id: 1, wardId: 1, illegalDumping: false, severity: 0.6, createdAt: new Date(Date.now() - 3600000) },
        { id: 2, wardId: 2, illegalDumping: true, severity: 0.8, createdAt: new Date(Date.now() - 7200000) },
        { id: 3, wardId: 1, illegalDumping: false, severity: 0.5, createdAt: new Date(Date.now() - 10800000) },
        { id: 4, wardId: 3, illegalDumping: true, severity: 0.7, createdAt: new Date(Date.now() - 14400000) },
        { id: 5, wardId: 2, illegalDumping: false, severity: 0.6, createdAt: new Date(Date.now() - 21600000) }
      ];
    }

    // Fetch predictions from API
    async function fetchPredictions() {
      try {
        const [preds, wardsResp] = await Promise.all([
          fetch('http://localhost:5000/api/intelligence/predictions'),
          fetch('http://localhost:5000/api/wards')
        ]);
        if (!preds.ok || !wardsResp.ok) throw new Error('API error');
        const predsData = await preds.json();
        const wardsData = await wardsResp.json();
        return { predictions: predsData.data, wards: wardsData.data };
      } catch (error) {
        console.warn('API error, using fallback:', error);
        initializeMockData();
        return {
          predictions: intelligenceEngine.wards.map(w => intelligenceEngine.predictOverflow(w.id)),
          wards: intelligenceEngine.wards
        };
      }
    }

    async function updateModule() {
      const { predictions, wards } = await fetchPredictions();

      // Ward table
      const wardTable = document.getElementById('wardTable');
      wardTable.innerHTML = predictions.map(pred => {
        const riskClass = pred.overflowProbability > 70 ? 'critical' : pred.overflowProbability > 40 ? 'high' : 'medium';
        return `
          <tr class="risk-${riskClass}">
            <td>${pred.wardName}</td>
            <td>${Math.round(pred.currentLoad)} kg</td>
            <td>300 kg</td>
            <td>
              <div class="risk-bar risk-${riskClass}">
                <div class="risk-fill" style="width: ${pred.overflowProbability}%;"></div>
              </div>
              <span style="color: var(--muted); font-size: 0.8rem;">${pred.overflowProbability.toFixed(1)}%</span>
            </td>
            <td>${pred.hoursToOverflow.toFixed(1)}h</td>
            <td><span class="urgency-badge urgency-${pred.urgencyLevel.toLowerCase()}">${pred.urgencyLevel}</span></td>
          </tr>
        `;
      }).join('');

      // Forecast chart
      const forecastChart = document.getElementById('forecastChart');
      const days = ['Today', 'Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6'];
      forecastChart.innerHTML = days.map((day, i) => {
        const value = 30 + (i * 12) + Math.random() * 10;
        return `
          <div class="forecast-bar">
            <div class="forecast-label">${day}</div>
            <div class="forecast-graph">
              <div class="forecast-fill" style="width: ${Math.min(value, 100)}%;"></div>
            </div>
            <div class="forecast-value">${Math.round(value)}%</div>
          </div>
        `;
      }).join('');

      // Critical wards - find highest risk
      const topRisk = predictions.reduce((max, pred) => pred.overflowProbability > max.overflowProbability ? pred : max);

      document.getElementById('criticalWards').innerHTML = `
        <div class="prediction-card">
          <div class="prediction-card-title">üìä Highest Risk Ward</div>
          <div class="prediction-stat">
            <div class="prediction-stat-label">Ward Name</div>
            <div style="font-size: 1.2rem; color: var(--cyan); margin-top: 4px;">${topRisk.wardName}</div>
          </div>
          <div class="prediction-stat">
            <div class="prediction-stat-label">Overflow Risk</div>
            <div class="prediction-stat-value" style="color: #ffd700;">${topRisk.overflowProbability.toFixed(1)}%</div>
          </div>
          <div class="prediction-stat">
            <div class="prediction-stat-label">Time to Overflow</div>
            <div style="font-size: 1.2rem; color: var(--emerald); margin-top: 4px;">${topRisk.hoursToOverflow.toFixed(1)} hours</div>
          </div>
        </div>
      `;

      // Timeline
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = [
        { hour: 2, event: 'Ward 2 reaches 60% capacity', action: 'Prepare truck' },
        { hour: 4, event: 'Ward 2 reaches 80% capacity', action: 'Deploy truck immediately' },
        { hour: 6, event: 'Ward 1 reaches 65% capacity', action: 'Monitor closely' },
        { hour: 8, event: 'Expected daily collection', action: 'Collection in progress' },
        { hour: 12, event: 'All wards return to safe levels', action: 'Complete' }
      ].map(item => `
        <div class="timeline-item">
          <div class="timeline-content">
            <div class="timeline-title">${item.event}</div>
            <div class="timeline-meta">‚è∞ ${item.hour} hours from now ¬∑ üìã ${item.action}</div>
          </div>
        </div>
      `).join('');

      // Update stats
      const avgRisk = predictions.length > 0 ? predictions.reduce((sum, p) => sum + p.overflowProbability, 0) / predictions.length : 0;
      const riskCount = predictions.filter(p => p.overflowProbability > 50).length;

      document.getElementById('avgOverflow').textContent = avgRisk.toFixed(1) + '%';
      document.getElementById('riskWards').textContent = riskCount;
    }

    document.addEventListener('DOMContentLoaded', updateModule);
  </script>
  <script src="enhanced-app.js"></script>
</body>
</html>
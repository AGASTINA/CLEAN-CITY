<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Madurai Swachh AI - Command Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .command-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .module-card {
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .module-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 40px 80px rgba(54, 240, 255, 0.2);
    }

    .module-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--cyan), var(--emerald));
      transition: left 0.5s ease;
    }

    .module-card:hover::before {
      left: 100%;
    }

    .module-title {
      font-size: 1.2rem;
      color: var(--cyan);
      margin-bottom: 12px;
    }

    .metric-large {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--emerald);
      margin: 10px 0;
    }

    .metric-label {
      color: var(--muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .alert-bubble {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .alert-bubble.critical {
      background: rgba(255, 77, 77, 0.2);
      color: #ff4d4d;
    }

    .alert-bubble.high {
      background: rgba(255, 215, 0, 0.2);
      color: #ffd700;
    }

    .alert-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .alert-item {
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-left: 3px solid;
      margin-bottom: 10px;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .alert-item.critical {
      border-left-color: #ff4d4d;
    }

    .alert-item.high {
      border-left-color: #ffd700;
    }

    .alert-item-title {
      font-weight: 600;
      color: var(--cyan);
    }

    .alert-item-detail {
      color: var(--muted);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .module-link {
      display: inline-block;
      margin-top: 15px;
      padding: 8px 16px;
      background: rgba(54, 240, 255, 0.1);
      border: 1px solid rgba(54, 240, 255, 0.3);
      border-radius: 6px;
      color: var(--cyan);
      text-decoration: none;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .module-link:hover {
      background: rgba(54, 240, 255, 0.2);
      border-color: var(--cyan);
    }

    .intelligence-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.85rem;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--emerald);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .prediction-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      margin: 8px 0;
      overflow: hidden;
    }

    .prediction-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--emerald), var(--cyan));
      transition: width 0.5s ease;
    }

    .map-container-mini {
      height: 300px;
      border-radius: 12px;
      overflow: hidden;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="bg">
    <div class="grid"></div>
    <canvas id="particles"></canvas>
    <div class="city-line"></div>
    <div class="temple-line"></div>
    <div class="glow-orbs"></div>
  </div>

  <header class="topbar">
    <div class="brand">
      <div class="logo">MS</div>
      <div>
        <div class="brand-title">MADURAI SWACHH AI GRID</div>
        <div class="brand-sub">Predictive Intelligence Command Center</div>
      </div>
    </div>
    <nav class="nav">
      <a href="detection-module.html">Detection</a>
      <a href="prediction-module.html">Prediction</a>
      <a href="escalation-module.html">Escalation</a>
      <a href="routing-module.html">Routing</a>
      <a href="circular-module.html">Circular</a>
      <a href="policy-module.html">Policy</a>
    </nav>
    <div class="actions">
      <button class="ghost" id="refreshBtn">üîÑ Refresh</button>
    </div>
  </header>

  <main>
    <!-- HERO SECTION -->
    <section class="hero">
      <div class="hero-content">
        <div class="chip">Real-time Operational Intelligence</div>
        <h1>Live Governance Command Center</h1>
        <p>
          Six interconnected AI modules working together to predict waste crises, 
          optimize operations, and generate governance intelligence for Madurai Corporation.
        </p>
        <div class="hero-stats">
          <div class="stat glass">
            <div class="stat-value" id="totalAlerts">0</div>
            <div class="stat-label">Active Alerts</div>
          </div>
          <div class="stat glass">
            <div class="stat-value" id="criticalCount">0</div>
            <div class="stat-label">Critical Issues</div>
          </div>
          <div class="stat glass">
            <div class="stat-value" id="trucksActive">0</div>
            <div class="stat-label">Trucks Deployed</div>
          </div>
        </div>
      </div>

      <div class="hero-visual glass">
        <div class="map-header">
          <span>System Status</span>
          <span class="status">Live</span>
        </div>
        <div style="padding: 20px; text-align: center;">
          <div class="loader"></div>
          <div style="margin-top: 15px; color: var(--muted);">Intelligence Engines Active</div>
          <div id="moduleStatus" style="margin-top: 10px; font-size: 0.9rem; color: var(--cyan);">
            ‚úì Detection ‚úì Prediction ‚úì Escalation
          </div>
        </div>
        <div class="map-footer">
          <div class="pill">Last Update: <span id="lastUpdate">loading...</span></div>
          <div class="pill">Wards: <span id="wardCount">15</span></div>
        </div>
      </div>
    </section>

    <!-- INTELLIGENCE MODULES DASHBOARD -->
    <section class="section" id="modules">
      <div class="section-header">
        <h2>üß† Six Intelligence Modules</h2>
        <p>Real-time prediction, alerting, optimization, and governance.</p>
      </div>

      <div class="command-grid">
        <!-- MODULE 1: Detection Layer -->
        <div class="card glass module-card" id="detection">
          <div class="module-title">ü§ñ Detection Layer</div>
          <div class="metric-label">AI Classification Engine</div>
          <div class="metric-large" id="detectCount">0</div>
          <div class="metric-label">Classifications Today</div>
          
          <div style="margin-top: 15px;">
            <div class="metric-label">Latest Detection</div>
            <div style="color: var(--cyan); font-weight: 600; margin-top: 5px;" id="latestDetection">
              Analyzing waste samples...
            </div>
          </div>

          <div class="intelligence-status">
            <div class="status-indicator"></div>
            <span>Camera Network Active</span>
          </div>

          <a href="detection-module.html" class="module-link">View Classifications ‚Üí</a>
        </div>

        <!-- MODULE 2: Prediction Engine -->
        <div class="card glass module-card" id="prediction">
          <div class="module-title">üìä Prediction Engine</div>
          <div class="metric-label">Overflow Probability</div>
          <div class="metric-large" id="avgRisk">0</div>
          <div>%</div>
          
          <div style="margin-top: 15px;">
            <div class="metric-label">At-Risk Wards</div>
            <div class="metric-large" id="riskWardCount" style="font-size: 2rem; color: #ffd700;">0</div>
          </div>

          <div class="intelligence-status">
            <div class="status-indicator"></div>
            <span>Analyzing patterns...</span>
          </div>

          <a href="prediction-module.html" class="module-link">View Predictions ‚Üí</a>
        </div>

        <!-- MODULE 3: Alert & Escalation -->
        <div class="card glass module-card" id="escalation">
          <div class="module-title">üö® Alert & Escalation</div>
          <div class="metric-label">Active Alerts</div>
          <div class="metric-large" id="alertCount">0</div>
          
          <div style="margin-top: 15px;">
            <div class="alert-bubble critical" id="critAlert">CRITICAL: <span id="critCount">0</span></div>
            <div class="alert-bubble high" id="highAlert">HIGH: <span id="highCount">0</span></div>
          </div>

          <div class="intelligence-status">
            <div class="status-indicator"></div>
            <span>Monitoring thresholds</span>
          </div>

          <a href="escalation-module.html" class="module-link">View Alerts ‚Üí</a>
        </div>

        <!-- MODULE 4: Route Optimization -->
        <div class="card glass module-card" id="routing">
          <div class="module-title">üó∫Ô∏è Route Optimization</div>
          <div class="metric-label">Fuel Savings Today</div>
          <div class="metric-large" id="fuelSavings">0</div>
          <div>L</div>
          
          <div style="margin-top: 15px;">
            <div class="metric-label">CO‚ÇÇ Reduced</div>
            <div style="color: var(--emerald); font-size: 1.5rem; font-weight: 700;" id="co2Reduced">0</div>
            <div class="metric-label">kg</div>
          </div>

          <div class="intelligence-status">
            <div class="status-indicator"></div>
            <span>Pathfinding active</span>
          </div>

          <a href="routing-module.html" class="module-link">View Routes ‚Üí</a>
        </div>

        <!-- MODULE 5: Circular Intelligence -->
        <div class="card glass module-card" id="circular">
          <div class="module-title">‚ôªÔ∏è Circular Intelligence</div>
          <div class="metric-label">Economic Value Generated</div>
          <div class="metric-large" id="circularRevenue">‚Çπ0</div>
          
          <div style="margin-top: 15px;">
            <div class="metric-label">SHG Jobs Created</div>
            <div style="color: var(--emerald); font-size: 1.5rem; font-weight: 700;" id="jobsCreated">0</div>
          </div>

          <div class="intelligence-status">
            <div class="status-indicator"></div>
            <span>Processing optimization</span>
          </div>

          <a href="circular-module.html" class="module-link">View Economics ‚Üí</a>
        </div>

        <!-- MODULE 6: Policy Intelligence -->
        <div class="card glass module-card" id="policy">
          <div class="module-title">üìã Policy Intelligence</div>
          <div class="metric-label">Recommendations Generated</div>
          <div class="metric-large" id="policyCount">0</div>
          
          <div style="margin-top: 15px;">
            <div class="metric-label">Budget Estimated</div>
            <div style="color: var(--emerald); font-size: 1.3rem; font-weight: 700;" id="budgetEstimate">‚Çπ0</div>
          </div>

          <div class="intelligence-status">
            <div class="status-indicator"></div>
            <span>Pattern analysis running</span>
          </div>

          <a href="policy-module.html" class="module-link">View Policies ‚Üí</a>
        </div>
      </div>
    </section>

    <!-- REAL-TIME ALERTS FEED -->
    <section class="section">
      <div class="section-header">
        <h2>üî¥ Real-Time Alert Feed</h2>
        <p>Critical and high-priority alerts requiring immediate action</p>
      </div>

      <div class="card glass">
        <div class="alert-list" id="alertsFeed">
          <div style="color: var(--muted); padding: 20px; text-align: center;">
            Loading alerts from intelligence engine...
          </div>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <section style="padding: 40px 6vw; text-align: center; color: var(--muted);">
      <p>Madurai Swachh AI Grid | Predictive Waste Governance Platform | Powered by Intelligence Engine v1.0</p>
      <p style="font-size: 0.85rem; margin-top: 20px;">
        Last synced: <span id="syncTime">--:--:--</span> | 
        Data confidence: <span id="confidence">95%</span>
      </p>
    </section>
  </main>

  <!-- Scripts -->
  <script src="intelligence.js"></script>
  <script>
    // Fetch data from backend API
    async function fetchIntelligenceData() {
      try {
        const response = await fetch('http://localhost:5000/api/intelligence/dashboard');
        if (!response.ok) throw new Error('API failed');
        const result = await response.json();
        return result.data;
      } catch (error) {
        console.error('API Error:', error);
        return null;
      }
    }

    // Initialize with backend data
    async function initializeData() {
      const apiData = await fetchIntelligenceData();
      
      if (apiData) {
        // Use real API data
        return apiData;
      } else {
        // Fallback to mock data
        intelligenceEngine.wards = [
          { id: 1, name: 'SS Colony Ward 1', population: 12500, wasteAmount: 75, cleanlinessIndex: 72 },
          { id: 2, name: 'Anna Main Road', population: 15800, wasteAmount: 85, cleanlinessIndex: 68 },
          { id: 3, name: 'Meenakshi Temple Zone', population: 18200, wasteAmount: 92, cleanlinessIndex: 65 },
          { id: 4, name: 'KK Nagar Ward 7', population: 14100, wasteAmount: 71, cleanlinessIndex: 78 },
          { id: 5, name: 'Vilakkuthoon Ward', population: 11300, wasteAmount: 62, cleanlinessIndex: 82 }
        ];
        intelligenceEngine.reports = [
          { id: 1, wardId: 1, illegalDumping: false, severity: 0.6, createdAt: new Date(Date.now() - 3600000) },
          { id: 2, wardId: 2, illegalDumping: true, severity: 0.8, createdAt: new Date(Date.now() - 7200000) },
          { id: 3, wardId: 1, illegalDumping: false, severity: 0.5, createdAt: new Date(Date.now() - 10800000) },
          { id: 4, wardId: 3, illegalDumping: true, severity: 0.7, createdAt: new Date(Date.now() - 14400000) },
          { id: 5, wardId: 2, illegalDumping: false, severity: 0.6, createdAt: new Date(Date.now() - 21600000) },
          { id: 6, wardId: 1, illegalDumping: true, severity: 0.9, createdAt: new Date(Date.now() - 25200000) }
        ];
        intelligenceEngine.trucks = [
          { id: 1, name: 'TN-58-MR-4012', status: 'active', assignedWard: null },
          { id: 2, name: 'TN-58-MR-4023', status: 'active', assignedWard: null },
          { id: 3, name: 'TN-58-MR-4087', status: 'available', assignedWard: null },
          { id: 4, name: 'TN-58-MR-4091', status: 'available', assignedWard: null }
        ];
        return intelligenceEngine.getDashboardData();
      }
    }

    // Update dashboard
    async function updateDashboard() {
      const data = await initializeData();
      
      if (!data) {
        console.warn('No data available');
        return;
      }

      // Update stats
      document.getElementById('totalAlerts').textContent = data.alerts?.total || 0;
      document.getElementById('criticalCount').textContent = data.alerts?.critical || 0;
      document.getElementById('trucksActive').textContent = data.trucks?.active || 0;
      document.getElementById('alertCount').textContent = data.alerts?.total || 0;
      document.getElementById('critCount').textContent = data.alerts?.critical || 0;
      document.getElementById('highCount').textContent = data.alerts?.high || 0;
      document.getElementById('avgRisk').textContent = data.predictions?.averageOverflowRisk || 0;
      document.getElementById('riskWardCount').textContent = data.predictions?.highRiskWards || 0;

      // Update last sync time
      const now = new Date();
      document.getElementById('syncTime').textContent = now.toLocaleTimeString();
      document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

      // Update alerts feed
      const alertsFeed = document.getElementById('alertsFeed');
      if (data && data.alerts && data.alerts.list && data.alerts.list.length > 0) {
        alertsFeed.innerHTML = data.alerts.list.map(alert => `
          <div class="alert-item ${alert.severity.toLowerCase()}">
            <div class="alert-item-title">
              ${alert.wardName} - ${alert.type.replace(/_/g, ' ')}
            </div>
            <div class="alert-item-detail">
              ${alert.message || 'Alert generated'}
            </div>
          </div>
        `).join('');
      } else {
        alertsFeed.innerHTML = '<div style="color: var(--muted); padding: 20px; text-align: center;">No active alerts - System operating normally</div>';
      }

      // Randomize some metrics for demo
      document.getElementById('detectCount').textContent = Math.floor(Math.random() * 20) + 5;
      document.getElementById('fuelSavings').textContent = Math.floor(Math.random() * 50) + 20;
      document.getElementById('co2Reduced').textContent = Math.floor(Math.random() * 100) + 50;
      document.getElementById('circularRevenue').textContent = '‚Çπ' + (Math.floor(Math.random() * 50000) + 10000).toLocaleString();
      document.getElementById('jobsCreated').textContent = Math.floor(Math.random() * 20) + 8;
      document.getElementById('policyCount').textContent = Math.floor(Math.random() * 8) + 2;
      document.getElementById('budgetEstimate').textContent = '‚Çπ' + (Math.floor(Math.random() * 500000) + 100000).toLocaleString();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await updateDashboard();

      // Refresh every 10 seconds
      document.getElementById('refreshBtn').addEventListener('click', updateDashboard);
      setInterval(updateDashboard, 10000);
    });
  </script>
  
  <script src="enhanced-app.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detection Layer - AI Waste Classification</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .classification-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .waste-type-card {
      padding: 15px;
      border-radius: 12px;
      background: rgba(54, 240, 255, 0.05);
      border: 1px solid rgba(54, 240, 255, 0.2);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .waste-type-card:hover {
      background: rgba(54, 240, 255, 0.1);
      border-color: var(--cyan);
      transform: translateY(-4px);
    }

    .waste-icon {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    .waste-name {
      font-weight: 600;
      color: var(--cyan);
    }

    .confidence-score {
      font-size: 2rem;
      font-weight: 700;
      color: var(--emerald);
      margin: 15px 0;
    }

    .confidence-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--emerald), var(--cyan));
    }

    .camera-stream {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: linear-gradient(135deg, rgba(54, 240, 255, 0.1), rgba(30, 142, 62, 0.1));
      border-radius: 12px;
      border: 2px solid rgba(54, 240, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin: 20px 0;
    }

    .camera-stream::before {
      content: 'üì∑';
      font-size: 4rem;
      opacity: 0.3;
    }

    .classification-history {
      max-height: 400px;
      overflow-y: auto;
    }

    .history-item {
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-left: 3px solid var(--cyan);
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .history-title {
      color: var(--cyan);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .history-meta {
      color: var(--muted);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .ai-indicators {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }

    .indicator {
      padding: 12px;
      background: rgba(30, 142, 62, 0.1);
      border: 1px solid var(--emerald);
      border-radius: 8px;
      text-align: center;
    }

    .indicator-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--emerald);
    }

    .indicator-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="bg">
    <div class="grid"></div>
    <canvas id="particles"></canvas>
  </div>

  <header class="topbar">
    <div class="brand">
      <div style="cursor: pointer;" onclick="window.location.href='intelligence-dashboard.html'">
        <div class="logo">MS</div>
      </div>
      <div>
        <div class="brand-title">DETECTION LAYER</div>
        <div class="brand-sub">AI Waste Classification Engine</div>
      </div>
    </div>
    <div class="actions">
      <button class="ghost" onclick="window.location.href='intelligence-dashboard.html'">‚Üê Back to Dashboard</button>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="hero-content">
        <div class="chip">Module 1 / 6</div>
        <h1>Detection Layer</h1>
        <p>Advanced waste classification system to identify waste types, assess severity levels, and track illegal dumping incidents in urban areas.</p>
        <div class="hero-stats">
          <div class="stat glass">
            <div class="stat-value" id="totalClassifications">0</div>
            <div class="stat-label">Classifications</div>
          </div>
          <div class="stat glass">
            <div class="stat-value" id="avgConfidence">95%</div>
            <div class="stat-label">Avg Confidence</div>
          </div>
          <div class="stat glass">
            <div class="stat-value" id="illegalDetections">0</div>
            <div class="stat-label">Illegal Dumps Detected</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Waste Detection Network Status</h2>
      </div>
      <div class="card glass">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
          <div style="text-align: center; padding: 15px; background: rgba(54, 240, 255, 0.05); border-radius: 8px;">
            <div style="font-size: 1.5rem; color: var(--emerald);">üìä 742</div>
            <div style="color: var(--muted); font-size: 0.85rem; margin-top: 5px;">Total Detections</div>
          </div>
          <div style="text-align: center; padding: 15px; background: rgba(54, 240, 255, 0.05); border-radius: 8px;">
            <div style="font-size: 1.5rem; color: var(--emerald);">‚úì 89%</div>
            <div style="color: var(--muted); font-size: 0.85rem; margin-top: 5px;">Accuracy</div>
          </div>
          <div style="text-align: center; padding: 15px; background: rgba(54, 240, 255, 0.05); border-radius: 8px;">
            <div style="font-size: 1.5rem; color: var(--cyan);">‚öôÔ∏è 0.2s</div>
            <div style="color: var(--muted); font-size: 0.85rem; margin-top: 5px;">Avg Processing</div>
          </div>
          <div style="text-align: center; padding: 15px; background: rgba(54, 240, 255, 0.05); border-radius: 8px;">
            <div style="font-size: 1.5rem; color: var(--emerald);">üîÑ Active</div>
            <div style="color: var(--muted); font-size: 0.85rem; margin-top: 5px;">System Status</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Waste Type Classification</h2>
        <p>Real-time detection of waste categories with confidence scores</p>
      </div>

      <div class="classification-grid" id="wasteTypes">
        <div class="card glass waste-type-card">
          <div class="waste-icon">üî§</div>
          <div class="waste-name">Plastic</div>
          <div class="confidence-bar">
            <div class="confidence-fill" style="width: 85%;"></div>
          </div>
          <div style="color: var(--muted); font-size: 0.8rem;">85% confidence</div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Detection Quality Metrics</h2>
      </div>
      <div class="card glass">
        <div class="ai-indicators">
          <div class="indicator">
            <div class="indicator-value" id="metricAccuracy">95%</div>
            <div class="indicator-label">Classification Accuracy</div>
          </div>
          <div class="indicator">
            <div class="indicator-value" id="metricProcessing">0.2s</div>
            <div class="indicator-label">Avg Processing Time</div>
          </div>
          <div class="indicator">
            <div class="indicator-value" id="metricSamples">1.2K</div>
            <div class="indicator-label">Samples Analyzed Today</div>
          </div>
          <div class="indicator">
            <div class="indicator-value" id="metricRecyclable">67%</div>
            <div class="indicator-label">Recyclable Rate</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Latest Classifications</h2>
      </div>
      <div class="card glass">
        <div class="classification-history" id="history">
          <div style="color: var(--muted); padding: 20px; text-align: center;">
            Loading classification history...
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="intelligence.js"></script>
  <script>
    // Fetch detection data from API
    async function fetchDetectionData() {
      try {
        const response = await fetch('http://localhost:3000/api/intelligence/detection');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const result = await response.json();
        return result.data;
      } catch (error) {
        console.warn('API error, using fallback:', error);
        return initializeMockDetectionData();
      }
    }

    // Fallback mock data
    function initializeMockDetectionData() {
      return {
        totalClassifications: 742,
        illegalDetections: 12,
        averageConfidence: 89.5,
        detectionHistory: [
          { id: 1, wardName: 'SS Colony Ward 1', timestamp: new Date(Date.now() - 120000), wasteType: 'Plastic', confidence: 92, isIllegalDumping: false },
          { id: 2, wardName: 'Anna Main Road', timestamp: new Date(Date.now() - 300000), wasteType: 'Organic', confidence: 85, isIllegalDumping: false },
          { id: 3, wardName: 'SS Colony Ward 1', timestamp: new Date(Date.now() - 480000), wasteType: 'Metal', confidence: 78, isIllegalDumping: false },
          { id: 4, wardName: 'Meenakshi Temple Zone', timestamp: new Date(Date.now() - 720000), wasteType: 'Construction', confidence: 88, isIllegalDumping: true },
          { id: 5, wardName: 'Anna Main Road', timestamp: new Date(Date.now() - 900000), wasteType: 'Plastic', confidence: 90, isIllegalDumping: false }
        ]
      };
    }

    // Update dashboard with real API data
    async function updateModule() {
      const detectionData = await fetchDetectionData();

      // Update hero stats
      document.getElementById('totalClassifications').textContent = detectionData.totalClassifications;
      document.getElementById('avgConfidence').textContent = detectionData.averageConfidence.toFixed(1) + '%';
      document.getElementById('illegalDetections').textContent = detectionData.illegalDetections;

      // Generate waste type cards from detection history
      const wasteTypeStats = {};
      const wasteIcons = { Plastic: 'üî§', Organic: 'üçÉ', Metal: '‚öôÔ∏è', Glass: 'üì¶', Hazardous: '‚ö†Ô∏è' };
      
      detectionData.detectionHistory.forEach(d => {
        if (!wasteTypeStats[d.wasteType]) {
          wasteTypeStats[d.wasteType] = { count: 0, confidences: [] };
        }
        wasteTypeStats[d.wasteType].count++;
        wasteTypeStats[d.wasteType].confidences.push(d.confidence);
      });

      const wasteTypesContainer = document.getElementById('wasteTypes');
      wasteTypesContainer.innerHTML = Object.entries(wasteTypeStats).map(([type, stats]) => {
        const avgConf = (stats.confidences.reduce((a, b) => a + b, 0) / stats.confidences.length).toFixed(0);
        return `
          <div class="card glass waste-type-card">
            <div class="waste-icon">${wasteIcons[type] || 'üóëÔ∏è'}</div>
            <div class="waste-name">${type}</div>
            <div class="confidence-bar">
              <div class="confidence-fill" style="width: ${avgConf}%;"></div>
            </div>
            <div style="color: var(--muted); font-size: 0.8rem;">${avgConf}% confidence (${stats.count} detections)</div>
          </div>
        `;
      }).join('');

      // Update detection history
      const historyContainer = document.getElementById('history');
      historyContainer.innerHTML = detectionData.detectionHistory.slice(0, 5).map(d => {
        const timeAgo = Math.floor((Date.now() - new Date(d.timestamp)) / 60000);
        const flagging = d.isIllegalDumping ? ' ‚ö†Ô∏è ILLEGAL' : '';
        return `
          <div class="history-item">
            <div class="history-title">${d.wasteType.toUpperCase()} - ${d.confidence.toFixed(0)}% Confidence${flagging}</div>
            <div class="history-meta">üìç ${d.wardName} ¬∑ ‚è∞ ${timeAgo} min ago</div>
          </div>
        `;
      }).join('');

      // Update metrics
      document.getElementById('metricAccuracy').textContent = detectionData.averageConfidence.toFixed(0) + '%';
      document.getElementById('metricProcessing').textContent = '0.2s';
      document.getElementById('metricSamples').textContent = (detectionData.totalClassifications / 600).toFixed(1) + 'K';
      document.getElementById('metricRecyclable').textContent = '67%';
    }

    document.addEventListener('DOMContentLoaded', updateModule);
  </script>
  <script src="enhanced-app.js"></script>
</body>
</html>